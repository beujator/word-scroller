<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory - Jeux √âducatifs</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @font-face {
            font-family: 'OpenDyslexic';
            src: url('OpenDyslexicAlta-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 20px;
            color: #2c3e50;
        }

        .stats span {
            font-weight: bold;
            color: #4a5568;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(6, 180px);
            gap: 20px;
            margin-bottom: 20px;
        }

        .memory-card {
            width: 180px;
            height: 180px;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .memory-card.flipped {
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            pointer-events: none;
            border: 4px solid #22c55e;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            font-size: 28px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            padding: 15px;
        }

        .card-front {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            font-weight: bold;
            font-size: 48px;
        }

        .card-back {
            background: white;
            transform: rotateY(180deg);
            color: #2c3e50;
            font-weight: bold;
            text-align: center;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            line-height: 1.2;
            overflow: hidden;
        }

        .card-back > div {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .card-back .syllable-2 {
            color: #c62828;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            background: #4a5568;
            color: white;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .home-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(74, 85, 104, 0.9);
            color: white;
            border: 2px solid rgba(74, 85, 104, 1);
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            z-index: 999;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .home-link:hover {
            background: rgba(74, 85, 104, 1);
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(74, 85, 104, 0.9);
            color: white;
            border: 2px solid rgba(74, 85, 104, 1);
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .admin-toggle:hover {
            background: rgba(74, 85, 104, 1);
        }

        .admin-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .admin-panel.visible {
            display: block;
        }

        .admin-panel h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .admin-panel textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-family: 'OpenDyslexic', 'Arial', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .admin-panel .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .admin-panel button {
            flex: 1;
            padding: 10px;
            background: #4a5568;
            color: white;
        }

        .admin-panel button:hover {
            background: #2d3748;
        }

        .admin-panel .info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
        }

        .message {
            color: #2c3e50;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            min-height: 30px;
        }

        .fire-truck {
            position: fixed;
            top: 50%;
            left: -200px;
            font-size: 80px;
            z-index: 9999;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .fire-truck.driving {
            animation: driveTruck 3s linear forwards;
        }

        @keyframes driveTruck {
            0% {
                left: -200px;
            }
            100% {
                left: 100%;
            }
        }

        .list-selector {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: inline-block;
        }

        .list-selector label {
            color: #2c3e50;
            font-weight: bold;
            margin-right: 10px;
        }

        .list-selector select {
            padding: 8px 15px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            font-size: 16px;
            background: white;
            cursor: pointer;
            min-width: 250px;
        }

        .list-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .list-status {
            margin-left: 10px;
            font-size: 14px;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .memory-grid {
                grid-template-columns: repeat(4, 140px);
            }

            .memory-card {
                width: 140px;
                height: 140px;
            }

            .card-face {
                font-size: 18px;
                padding: 10px;
            }

            .card-front {
                font-size: 40px;
            }

            .card-back {
                font-size: 18px;
            }

            .list-selector {
                display: block;
            }

            .list-selector select {
                min-width: 200px;
                display: block;
                margin: 10px auto;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="home-link">‚Üê Accueil</a>
    <button class="admin-toggle" id="adminToggle">Admin</button>

    <div class="admin-panel" id="adminPanel">
        <h2>Gestion des Paires</h2>
        <textarea id="pairsInput" placeholder="Entrez les mots pour les paires (un par ligne avec syllabes s√©par√©es par ,)&#10;Exemple:&#10;mai,son&#10;jar,din&#10;voi,ture&#10;so,leil&#10;li,vre&#10;fleur&#10;ar,bre&#10;eau"></textarea>
        <div class="button-group">
            <button id="savePairs">Sauvegarder</button>
            <button id="resetPairs">R√©initialiser</button>
        </div>
        <button id="resetScore">R√©initialiser le score</button>
        <button id="closeAdmin">Fermer</button>
        <div class="info">
            üí° Entrez une liste de mots (un par ligne).<br>
            Utilisez la virgule (,) pour s√©parer les syllabes.<br>
            La 2√®me syllabe appara√Ætra en rouge.<br>
            Minimum 8 mots recommand√©s.
        </div>
    </div>

    <h1>Memory</h1>

    <div class="list-selector" id="listSelector">
        <label for="onlineList">Liste de mots: </label>
        <select id="onlineList">
            <option value="">üì± Liste locale (personnalis√©e)</option>
        </select>
        <span id="listStatus" class="list-status"></span>
    </div>

    <div class="stats">
        <div>Coups: <span id="movesValue">0</span></div>
        <div>Paires: <span id="pairsValue">0</span>/<span id="totalPairs">9</span></div>
        <div>Score: <span id="scoreValue">0</span></div>
    </div>

    <div class="game-container">
        <div class="memory-grid" id="memoryGrid"></div>
    </div>

    <div class="controls">
        <button id="newGame">Nouvelle partie</button>
        <button id="fireTruckBtn">üöí Camion Pompier</button>
    </div>

    <div class="message" id="message"></div>
    <div class="fire-truck" id="fireTruck">üöí</div>

    <script>
        // Mots par d√©faut avec s√©paration syllabique
        const defaultSymbols = ['mai,son', 'jar,din', 'voi,ture', 'so,leil', 'li,vre', 'fleur', 'ar,bre', 'eau', 'f√™,te'];

        // Variables
        let symbols = [];
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let score = 0;
        let canFlip = true;
        let mismatchTimeout = null;
        let fireTruckUses = 3;

        // R√©cup√©rer les √©l√©ments
        const memoryGrid = document.getElementById('memoryGrid');
        const movesValue = document.getElementById('movesValue');
        const pairsValue = document.getElementById('pairsValue');
        const totalPairs = document.getElementById('totalPairs');
        const scoreValue = document.getElementById('scoreValue');
        const message = document.getElementById('message');
        const newGameBtn = document.getElementById('newGame');
        const adminToggle = document.getElementById('adminToggle');
        const adminPanel = document.getElementById('adminPanel');
        const pairsInput = document.getElementById('pairsInput');
        const savePairsBtn = document.getElementById('savePairs');
        const resetPairsBtn = document.getElementById('resetPairs');
        const resetScoreBtn = document.getElementById('resetScore');
        const closeAdminBtn = document.getElementById('closeAdmin');
        const fireTruckBtn = document.getElementById('fireTruckBtn');
        const fireTruck = document.getElementById('fireTruck');
        const onlineListSelect = document.getElementById('onlineList');
        const listStatus = document.getElementById('listStatus');

        // API pour les listes en ligne
        const API_BASE = window.location.origin + '/api/lists';

        // Charger les symboles
        function loadSymbols() {
            const savedSymbols = localStorage.getItem('memorySymbols');
            let symbolFullList;
            if (savedSymbols) {
              symbolFullList = JSON.parse(savedSymbols);
            } else {
              symbolFullList = [...defaultSymbols];
            }
            symbols = shuffle(symbolFullList).slice(0,9);
            console.log(symbols.length)
        }

        // Sauvegarder les symboles
        function saveSymbols(symbolList) {
            symbols = shuffle(symbolList).slice(0,9);
            localStorage.setItem('memorySymbols', JSON.stringify(symbols));
        }

        // Charger le score
        function loadScore() {
            const savedScore = localStorage.getItem('memoryTotalScore');
            if (savedScore) {
                score = parseInt(savedScore);
                scoreValue.textContent = score;
            }
        }

        // Sauvegarder le score
        function saveScore() {
            localStorage.setItem('memoryTotalScore', score.toString());
            scoreValue.textContent = score;
        }

        // M√©langer un tableau
        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Formater un mot avec les syllabes color√©es
        function formatWord(word) {
            const syllables = word.split(',');
            let html = '';
            syllables.forEach((syllable, index) => {
                if (index === 1) {
                    html += `<span class="syllable-2">${syllable}</span>`;
                } else {
                    html += syllable;
                }
            });
            return html;
        }

        // Cr√©er le plateau de jeu
        function createBoard() {
            // Cr√©er les paires
            const pairs = [];
            symbols.forEach(symbol => {
                pairs.push(symbol, symbol);
            });

            // M√©langer
            cards = shuffle(pairs);

            // Cr√©er les cartes
            memoryGrid.innerHTML = '';
            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.symbol = symbol;
                card.dataset.index = index;

                const cardFront = document.createElement('div');
                cardFront.className = 'card-face card-front';
                cardFront.textContent = '?';

                const cardBack = document.createElement('div');
                cardBack.className = 'card-face card-back';
                const wordContainer = document.createElement('div');
                wordContainer.innerHTML = formatWord(symbol);
                cardBack.appendChild(wordContainer);

                card.appendChild(cardFront);
                card.appendChild(cardBack);

                card.addEventListener('click', () => flipCard(card, index));
                memoryGrid.appendChild(card);
            });

            // R√©initialiser les stats
            moves = 0;
            matchedPairs = 0;
            flippedCards = [];
            fireTruckUses = 3;
            movesValue.textContent = moves;
            pairsValue.textContent = matchedPairs;
            totalPairs.textContent = symbols.length;
            message.textContent = '';
            updateFireTruckButton();
        }

        // Retourner une carte
        function flipCard(card, index) {
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;

            // Si on a 2 cartes retourn√©es qui ne matchent pas, annuler le timeout et les retourner imm√©diatement
            if (flippedCards.length === 2 && mismatchTimeout) {
                clearTimeout(mismatchTimeout);
                mismatchTimeout = null;
                const [card1, card2] = flippedCards;
                card1.card.classList.remove('flipped');
                card2.card.classList.remove('flipped');
                flippedCards = [];
                canFlip = true;
            }

            if (!canFlip) return;
            if (flippedCards.length >= 2) return;

            card.classList.add('flipped');
            flippedCards.push({ card, symbol: card.dataset.symbol, index });

            if (flippedCards.length === 2) {
                moves++;
                movesValue.textContent = moves;
                checkMatch();
            }
        }

        // V√©rifier la correspondance
        function checkMatch() {
            canFlip = false;
            const [card1, card2] = flippedCards;

            if (card1.symbol === card2.symbol && card1.index !== card2.index) {
                // Paire trouv√©e
                setTimeout(() => {
                    card1.card.classList.add('matched');
                    card2.card.classList.add('matched');
                    matchedPairs++;
                    pairsValue.textContent = matchedPairs;

                    // Points: plus de points pour moins de coups
                    const pointsEarned = Math.max(10 - Math.floor(moves / 2), 1);
                    score += pointsEarned;
                    saveScore();

                    // Explosion de confettis!
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });

                    showMessage(`‚úì Bravo! +${pointsEarned} points`, 'green');

                    flippedCards = [];
                    canFlip = true;

                    // V√©rifier si toutes les paires sont trouv√©es
                    if (matchedPairs === symbols.length) {
                        setTimeout(() => {
                            showMessage(`üéâ Partie termin√©e en ${moves} coups!`, 'green');
                            // Encore plus de confettis pour la fin!
                            confetti({
                                particleCount: 200,
                                spread: 100,
                                origin: { y: 0.6 }
                            });
                        }, 500);
                    }
                }, 500);
            } else {
                // Pas de correspondance
                mismatchTimeout = setTimeout(() => {
                    card1.card.classList.remove('flipped');
                    card2.card.classList.remove('flipped');
                    flippedCards = [];
                    canFlip = true;
                    mismatchTimeout = null;
                }, 6000);
            }
        }

        // Afficher un message
        function showMessage(text, color) {
            message.textContent = text;
            message.style.color = color === 'green' ? '#22c55e' : '#ef4444';
            setTimeout(() => {
                message.textContent = '';
            }, 2000);
        }

        // Mettre √† jour le bouton camion de pompier
        function updateFireTruckButton() {
            if (fireTruckUses > 0) {
                fireTruckBtn.textContent = `üöí Camion Pompier (${fireTruckUses})`;
                fireTruckBtn.disabled = false;
                fireTruckBtn.style.opacity = '1';
            } else {
                fireTruckBtn.textContent = 'üöí Camion Pompier (0)';
                fireTruckBtn.disabled = true;
                fireTruckBtn.style.opacity = '0.5';
                fireTruckBtn.style.cursor = 'not-allowed';
            }
        }

        // Camion de pompier - retourne toutes les cartes
        function showFireTruck() {
            if (!canFlip) return; // Ne pas lancer si d√©j√† en cours
            if (fireTruckUses <= 0) return; // Plus d'utilisations disponibles

            fireTruckUses--;
            updateFireTruckButton();
            canFlip = false;

            // Retourner toutes les cartes non match√©es
            const allCards = document.querySelectorAll('.memory-card:not(.matched)');
            allCards.forEach(card => {
                card.classList.add('flipped');
            });

            // Lancer l'animation du camion
            fireTruck.classList.add('driving');

            // Apr√®s 3 secondes, remettre les cartes face cach√©e
            setTimeout(() => {
                allCards.forEach(card => {
                    card.classList.remove('flipped');
                });

                // Retirer la classe d'animation du camion
                fireTruck.classList.remove('driving');

                // R√©initialiser la position du camion
                setTimeout(() => {
                    canFlip = true;
                }, 500);
            }, 3000);
        }

        // Charger les listes en ligne disponibles
        async function loadOnlineLists() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();

                if (data.success && data.lists.length > 0) {
                    // Filtrer les listes pour ce jeu (memory ou all)
                    const memoryLists = data.lists.filter(list =>
                        list.game === 'memory' || list.game === 'all'
                    );

                    memoryLists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.name;
                        option.textContent = `‚òÅÔ∏è ${list.name} (${list.wordCount} mots)`;
                        onlineListSelect.appendChild(option);
                    });

                    listStatus.textContent = `${memoryLists.length} liste(s) en ligne`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des listes:', error);
                listStatus.textContent = '‚ö†Ô∏è Hors ligne';
            }
        }

        // Charger une liste en ligne sp√©cifique
        async function loadOnlineList(listName) {
            try {
                listStatus.textContent = '‚è≥ Chargement...';
                const response = await fetch(`${API_BASE}/${encodeURIComponent(listName)}`);
                const data = await response.json();

                if (data.success && data.list.words) {
                    symbols = shuffle(data.list.words).slice(0,9);
                    createBoard();
                    listStatus.textContent = '‚úì Liste charg√©e';

                    setTimeout(() => {
                        listStatus.textContent = '';
                    }, 2000);
                } else {
                    listStatus.textContent = '‚ùå Erreur de chargement';
                    setTimeout(() => {
                        onlineListSelect.value = '';
                        loadSymbols();
                        createBoard();
                    }, 2000);
                }
            } catch (error) {
                console.error('Erreur:', error);
                listStatus.textContent = '‚ùå Erreur de connexion';
                setTimeout(() => {
                    onlineListSelect.value = '';
                    loadSymbols();
                    createBoard();
                }, 2000);
            }
        }

        // G√©rer le changement de s√©lection de liste
        onlineListSelect.addEventListener('change', (e) => {
            const selectedList = e.target.value;
            if (selectedList) {
                // Charger la liste en ligne
                loadOnlineList(selectedList);
            } else {
                // Utiliser la liste locale
                loadSymbols();
                createBoard();
                listStatus.textContent = '';
            }
        });

        // Nouvelle partie
        newGameBtn.addEventListener('click', () => {
            // Recharger et m√©langer les symboles
            const savedSymbols = localStorage.getItem('memorySymbols');
            let symbolFullList;
            if (savedSymbols) {
                symbolFullList = JSON.parse(savedSymbols);
            } else {
                symbolFullList = [...defaultSymbols];
            }
            symbols = shuffle(symbolFullList).slice(0,9);
            createBoard();
        });

        // Bouton camion de pompier
        fireTruckBtn.addEventListener('click', showFireTruck);

        // Panneau d'administration
        adminToggle.addEventListener('click', () => {
            adminPanel.classList.toggle('visible');
            if (adminPanel.classList.contains('visible')) {
                pairsInput.value = symbols.join('\n');
            }
        });

        closeAdminBtn.addEventListener('click', () => {
            adminPanel.classList.remove('visible');
        });

        // Sauvegarder les nouvelles paires
        savePairsBtn.addEventListener('click', () => {
            const newSymbols = pairsInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (newSymbols.length >= 4) {
                saveSymbols(newSymbols);
                createBoard();
                adminPanel.classList.remove('visible');
                alert('Liste sauvegard√©e!');
            } else {
                alert('Veuillez entrer au moins 4 symboles.');
            }
        });

        // R√©initialiser aux symboles par d√©faut
        resetPairsBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment r√©initialiser la liste aux symboles par d√©faut?')) {
                saveSymbols([...defaultSymbols]);
                pairsInput.value = symbols.join('\n');
                createBoard();
                alert('Liste r√©initialis√©e!');
            }
        });

        // R√©initialiser le score
        resetScoreBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment r√©initialiser le score?')) {
                score = 0;
                saveScore();
                alert('Score r√©initialis√©!');
            }
        });

        // Initialisation
        loadSymbols();
        loadScore();
        createBoard();
        loadOnlineLists(); // Charger les listes en ligne disponibles
    </script>
</body>
</html>
