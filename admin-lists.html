<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration des Listes - Jeux √âducatifs</title>
    <style>
        @font-face {
            font-family: 'OpenDyslexic';
            src: url('OpenDyslexicAlta-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            text-align: center;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-section.authenticated {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        input[type="text"],
        input[type="password"],
        textarea {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="password"] {
            min-width: 300px;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        button.danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .admin-content {
            display: none;
        }

        .admin-content.visible {
            display: block;
        }

        .section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .lists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .list-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .list-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .list-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .list-card p {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .list-card .meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #6b7280;
        }

        .list-card .actions {
            display: flex;
            gap: 10px;
        }

        .list-card button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'OpenDyslexic', 'Arial', sans-serif;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            color: #166534;
            display: block;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #991b1b;
            display: block;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 18px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .form-help {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        #editor-section {
            display: none;
        }

        #editor-section.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Retour au menu</a>

        <h1>Administration des Listes de Mots</h1>

        <!-- Section d'authentification -->
        <div id="auth-section" class="auth-section">
            <h2>Authentification Administrateur</h2>
            <p id="auth-status">Veuillez entrer votre token d'administration</p>
            <div class="input-group">
                <input type="password" id="admin-token" placeholder="Token d'administration">
                <button onclick="authenticate()">Se connecter</button>
            </div>
        </div>

        <!-- Contenu admin (visible apr√®s authentification) -->
        <div id="admin-content" class="admin-content">
            <div id="status-message" class="status-message"></div>

            <!-- Section liste des listes -->
            <div id="lists-section" class="section">
                <h2>Listes de Mots Existantes</h2>
                <div id="lists-grid" class="lists-grid">
                    <!-- Les listes seront charg√©es ici -->
                </div>
                <button onclick="showEditor()">+ Cr√©er une nouvelle liste</button>
            </div>

            <!-- Section √©diteur de liste -->
            <div id="editor-section" class="section">
                <h2 id="editor-title">Cr√©er une nouvelle liste</h2>

                <div class="form-group">
                    <label for="list-name">Nom de la liste *</label>
                    <input type="text" id="list-name" placeholder="Ex: Semaine du 4 novembre, Sons ON/AN">
                    <div class="form-help">Ce nom sera affich√© dans le s√©lecteur des jeux</div>
                </div>

                <div class="form-group">
                    <label for="list-description">Description</label>
                    <input type="text" id="list-description" placeholder="Ex: Sons complexes ON et AN">
                </div>

                <div class="form-group">
                    <label for="list-game">Jeu cible</label>
                    <select id="list-game">
                        <option value="all">Tous les jeux</option>
                        <option value="memory">Memory</option>
                        <option value="rocket">Fus√©e des Syllabes</option>
                        <option value="scroller">D√©fileur de Mots</option>
                        <option value="doubles">Trouve les Doubles</option>
                    </select>
                    <div class="form-help">S√©lectionnez le jeu pour lequel cette liste est destin√©e</div>
                </div>

                <div class="form-group">
                    <label for="list-words">Mots (un par ligne) *</label>
                    <textarea id="list-words" placeholder="mai,son&#10;jar,din&#10;voi,ture&#10;so,leil"></textarea>
                    <div class="form-help">S√©parez les syllabes par des virgules. La 2√®me syllabe sera affich√©e en rouge.</div>
                </div>

                <div class="form-actions">
                    <button class="secondary" onclick="cancelEdit()">Annuler</button>
                    <button onclick="saveList()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/lists';
        let currentToken = null;
        let editingListName = null;

        // Charger le token depuis sessionStorage au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = sessionStorage.getItem('adminToken');
            // V√©rifier que le token n'est pas un JSON ou un message d'erreur
            if (savedToken && !savedToken.startsWith('{') && savedToken.length > 10) {
                currentToken = savedToken;
                showAuthenticatedUI();
                loadLists();
            } else if (savedToken) {
                // Token corrompu, nettoyer
                sessionStorage.removeItem('adminToken');
            }
        });

        // Authentification
        function authenticate() {
            const token = document.getElementById('admin-token').value.trim();
            if (!token) {
                showStatus('Veuillez entrer un token', 'error');
                return;
            }

            // V√©rifier que le token n'est pas un JSON
            if (token.startsWith('{')) {
                showStatus('Token invalide (ne collez pas le message d\'erreur)', 'error');
                return;
            }

            currentToken = token;
            sessionStorage.setItem('adminToken', token);
            showAuthenticatedUI();
            loadLists();
        }

        function showAuthenticatedUI() {
            document.getElementById('auth-section').classList.add('authenticated');
            document.getElementById('auth-status').textContent = '‚úì Authentifi√©';
            document.getElementById('admin-token').style.display = 'none';
            document.getElementById('auth-section').querySelector('button').style.display = 'none';
            document.getElementById('admin-content').classList.add('visible');
        }

        // Charger toutes les listes
        async function loadLists() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();

                if (data.success) {
                    displayLists(data.lists);
                } else {
                    showStatus('Erreur lors du chargement des listes', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Erreur de connexion √† l\'API', 'error');
            }
        }

        // Afficher les listes
        function displayLists(lists) {
            const grid = document.getElementById('lists-grid');

            if (lists.length === 0) {
                grid.innerHTML = '<div class="empty-state">Aucune liste cr√©√©e pour le moment</div>';
                return;
            }

            grid.innerHTML = lists.map(list => `
                <div class="list-card">
                    <h3>${escapeHtml(list.name)}</h3>
                    <p>${escapeHtml(list.description || 'Pas de description')}</p>
                    <div class="meta">
                        <span>üéÆ ${getGameLabel(list.game)}</span>
                        <span>üìù ${list.wordCount} mots</span>
                    </div>
                    <div class="meta">
                        <span>üïê ${formatDate(list.updatedAt)}</span>
                    </div>
                    <div class="actions">
                        <button onclick="editList('${escapeHtml(list.name)}')">Modifier</button>
                        <button class="danger" onclick="deleteList('${escapeHtml(list.name)}')">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        // Afficher l'√©diteur
        function showEditor() {
            document.getElementById('editor-section').classList.add('visible');
            document.getElementById('editor-title').textContent = 'Cr√©er une nouvelle liste';
            document.getElementById('list-name').value = '';
            document.getElementById('list-description').value = '';
            document.getElementById('list-game').value = 'all';
            document.getElementById('list-words').value = '';
            editingListName = null;
            document.getElementById('list-name').disabled = false;
        }

        // Modifier une liste existante
        async function editList(listName) {
            try {
                const response = await fetch(`${API_BASE}/${encodeURIComponent(listName)}`);
                const data = await response.json();

                if (data.success) {
                    editingListName = listName;
                    document.getElementById('editor-section').classList.add('visible');
                    document.getElementById('editor-title').textContent = `Modifier: ${listName}`;
                    document.getElementById('list-name').value = data.list.name;
                    document.getElementById('list-name').disabled = true;
                    document.getElementById('list-description').value = data.list.description || '';
                    document.getElementById('list-game').value = data.list.game || 'all';
                    document.getElementById('list-words').value = data.list.words.join('\n');

                    // Scroll vers l'√©diteur
                    document.getElementById('editor-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showStatus('Erreur lors du chargement de la liste', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Erreur de connexion √† l\'API', 'error');
            }
        }

        // Annuler l'√©dition
        function cancelEdit() {
            document.getElementById('editor-section').classList.remove('visible');
            editingListName = null;
        }

        // Sauvegarder une liste
        async function saveList() {
            const name = document.getElementById('list-name').value.trim();
            const description = document.getElementById('list-description').value.trim();
            const game = document.getElementById('list-game').value;
            const wordsText = document.getElementById('list-words').value.trim();

            if (!name) {
                showStatus('Le nom de la liste est requis', 'error');
                return;
            }

            if (!wordsText) {
                showStatus('La liste de mots est requise', 'error');
                return;
            }

            const words = wordsText.split('\n').map(w => w.trim()).filter(w => w);

            if (words.length === 0) {
                showStatus('La liste doit contenir au moins un mot', 'error');
                return;
            }

            const listData = {
                description,
                game,
                words
            };

            try {
                console.log('Token utilis√©:', currentToken);
                console.log('Headers:', {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                });

                const response = await fetch(`${API_BASE}/${encodeURIComponent(name)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(listData)
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                    cancelEdit();
                    loadLists();
                } else {
                    showStatus(data.error || 'Erreur lors de la sauvegarde', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Erreur de connexion √† l\'API', 'error');
            }
        }

        // Supprimer une liste
        async function deleteList(listName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la liste "${listName}" ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${encodeURIComponent(listName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                    loadLists();
                } else {
                    showStatus(data.error || 'Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Erreur de connexion √† l\'API', 'error');
            }
        }

        // Afficher un message de statut
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;

            setTimeout(() => {
                statusEl.className = 'status-message';
            }, 5000);
        }

        // Utilitaires
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getGameLabel(game) {
            const labels = {
                'all': 'Tous',
                'memory': 'Memory',
                'rocket': 'Fus√©e',
                'scroller': 'D√©fileur',
                'doubles': 'Doubles'
            };
            return labels[game] || game;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
